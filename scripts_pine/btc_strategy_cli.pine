//@version=5
indicator("BTC IFVG + Volume Profile + EMAs Strategy", overlay=true, timeframe="", timeframe_gaps=true)

// =============================================================================
// BTC IFVG + VOLUME PROFILE + EMAS STRATEGY - PINE SCRIPT v5
// =============================================================================
// Generated by BTC Trading IA System
// Generated: 2025-11-12 22:15:18
// Parameters optimized for: BTCUSD
// Optimization method: manual
// Best score: 0
// =============================================================================

// =============================================================================
// INPUT PARAMETERS
// =============================================================================

// IFVG Parameters
atrLength = input.int(14, "ATR Length", minval=5, maxval=50)
atrMultiplier = input.float(1.5, "ATR Multiplier", minval=0.1, maxval=3.0, step=0.1)

// Volume Profile Parameters
vpRows = input.int(120, "VP Rows", minval=50, maxval=200)
vaPercent = input.float(0.7, "VA Percent", minval=0.6, maxval=0.8, step=0.01)
sdThresh = input.float(0.12, "SD Threshold", minval=0.1, maxval=0.3, step=0.01)

// EMA Parameters
emaFast5m = input.int(18, "EMA Fast 5m", minval=5, maxval=50)
emaSlow5m = input.int(48, "EMA Slow 5m", minval=20, maxval=100)
emaFast15m = input.int(18, "EMA Fast 15m", minval=5, maxval=50)
emaSlow15m = input.int(48, "EMA Slow 15m", minval=20, maxval=100)
emaFast1h = input.int(95, "EMA Fast 1h", minval=20, maxval=150)
emaSlow1h = input.int(200, "EMA Slow 1h", minval=50, maxval=300)

// Volume & Risk Parameters
volThresh = input.float(1.2, "Volume Threshold", minval=0.5, maxval=2.0, step=0.1)
minConfidence = input.float(0.6, "Min Confidence", minval=0.1, maxval=1.0, step=0.1)
tpRR = input.float(2.2, "Take Profit RR", minval=1.0, maxval=5.0, step=0.1)

// =============================================================================
// INDICATOR CALCULATIONS
// =============================================================================

// ATR for IFVG
atr = ta.atr(atrLength)

// IFVG Calculation (simplified for Pine)
highPrev = ta.valuewhen(ta.barstate.islast, high[1], 0)
lowPrev = ta.valuewhen(ta.barstate.islast, low[1], 0)
closePrev = ta.valuewhen(ta.barstate.islast, close[1], 0)

gapUp = close > highPrev and low > highPrev
gapDown = close < lowPrev and high < lowPrev

ifvgBull = gapUp and close > closePrev
ifvgBear = gapDown and close < closePrev

// Volume Profile (simplified - POC from recent bars)
vpLength = input.int(50, "VP Lookback", minval=20, maxval=200)
vpHigh = ta.highest(high, vpLength)
vpLow = ta.lowest(low, vpLength)
pocPrice = (vpHigh + vpLow) / 2  // Simplified POC

// EMAs
emaFast = ta.ema(close, emaFast5m)
emaSlow = ta.ema(close, emaSlow5m)

// Higher timeframe EMAs (simplified)
emaFastHTF = ta.ema(close, emaFast15m)
emaSlowHTF = ta.ema(close, emaSlow15m)

// Trend filter (1H EMA)
emaTrend = ta.ema(close, emaSlow1h)

// Volume conditions
volSMA = ta.sma(volume, 21)
volCondition = volume > volThresh * volSMA

// =============================================================================
// SIGNAL GENERATION
// =============================================================================

// Trend filter (close > EMA200_1h)
trendUp = close > emaTrend

// Momentum (EMA20_5m > EMA50_15m)
momentumUp = emaFast > emaFastHTF

// Confluence scoring
bullScore = 0.0
bullScore += ifvgBull ? 2.0 : 0.0
bullScore += close > pocPrice ? 1.0 : 0.0
bullScore += momentumUp ? 1.0 : 0.0
bullScore += volCondition ? 1.0 : 0.0
bullScore += trendUp ? 1.0 : 0.0

bearScore = 0.0
bearScore += ifvgBear ? 2.0 : 0.0
bearScore += close < pocPrice ? 1.0 : 0.0
bearScore += not momentumUp ? 1.0 : 0.0
bearScore += volCondition ? 1.0 : 0.0
bearScore += not trendUp ? 1.0 : 0.0

// Entry signals
bullSignal = bullScore >= 4.0 and trendUp
bearSignal = bearScore >= 4.0 and not trendUp

// =============================================================================
// PLOTTING
// =============================================================================

// Plot EMAs
plot(emaFast, color=color.blue, title="EMA Fast", linewidth=1)
plot(emaSlow, color=color.red, title="EMA Slow", linewidth=1)
plot(emaTrend, color=color.purple, title="Trend EMA", linewidth=2)

// Plot IFVG
plotshape(ifvgBull, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="IFVG Bull")
plotshape(ifvgBear, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="IFVG Bear")

// Plot Volume Profile
plot(pocPrice, color=color.orange, title="POC", linewidth=2, style=plot.style_linebr)

// Plot signals
plotshape(bullSignal, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.large, title="Bull Signal")
plotshape(bearSignal, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.large, title="Bear Signal")

// Plot confluence scores
plot(bullScore, color=color.green, title="Bull Score", style=plot.style_histogram, linewidth=2)
plot(bearScore, color=color.red, title="Bear Score", style=plot.style_histogram, linewidth=2)

// =============================================================================
// ALERTS
// =============================================================================

alertcondition(bullSignal, title="Bull Signal Alert", message="BTC Bull Signal - Score: {bullScore}")
alertcondition(bearSignal, title="Bear Signal Alert", message="BTC Bear Signal - Score: {bearScore}")

// =============================================================================
// STRATEGY (for backtesting in Pine)
// =============================================================================

if strategy.position_size == 0
    if bullSignal
        strategy.entry("Long", strategy.long)
    else if bearSignal
        strategy.entry("Short", strategy.short)

// Risk management
stopLoss = strategy.position_avg_price * (1 - atrMultiplier * atr / strategy.position_avg_price)
takeProfit = strategy.position_avg_price * (1 + tpRR * atrMultiplier * atr / strategy.position_avg_price)

strategy.exit("Exit Long", "Long", stop=stopLoss, limit=takeProfit)
strategy.exit("Exit Short", "Short", stop=stopLoss, limit=takeProfit)

// =============================================================================
// STATISTICS
// =============================================================================

// Display confluence scores
plotchar(true, "Bull Score", tostring(bullScore), location=location.top, color=color.green, textcolor=color.white)
plotchar(true, "Bear Score", tostring(bearScore), location=location.top, color=color.red, textcolor=color.white)

// Display current ATR
plotchar(true, "ATR", tostring(atr), location=location.top, color=color.blue, textcolor=color.white)
